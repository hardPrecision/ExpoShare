{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/exhibition.css') }}">
{% endblock %}

{% block content %}
  <div class="exhibition-header">
    <h1 class="exhibition-title">{{ exhibition.name }}</h1>
    <div id="page-indicator" class="page-indicator">1/{{ items|length }}</div>
  </div>
  <div class="exhibition-container">
    <button onclick="prevItem()" class="nav-btn">←</button>
    <div class="current-item" id="current-item"></div>
    <button onclick="nextItem()" class="nav-btn">→</button>
  </div>

  <script>
    const userUuid = '{{ user_uuid }}';
    let currentItemIndex = 0;
    const items = {{ items|tojson }};
    const exhibitionId = {{ exhibition.id }};
    const slideCache = {};

    function updateCurrentItem() {
      const currentItem = items[currentItemIndex];
      const ext = currentItem.filename ? currentItem.filename.split('.').pop().toLowerCase() : '';

      const title = currentItem.name || (currentItem.filename ? currentItem.filename.split('.')[0].replace(/_/g, ' ') : 'Без названия');
      const description = currentItem.description || currentItem.desc || currentItem.text || currentItem.annotation || 'Описание отсутствует';

      const container = document.getElementById('current-item');
      let contentHtml = '';
      if (ext === 'md' || ext === 'html') {
        contentHtml = `<div id="layout-render" class="item-content layout-block"><div class="spinner"></div></div>`;
      } else if (isImage(currentItem.filename)) {
        contentHtml = `
          <div class="item-display">
            <img src="/uploads/exhibitions/${userUuid}/${exhibitionId}/${currentItem.filename}" class="display-image" alt="${title}" />
            <div class="item-info">
              <h2 class="item-title">${title}</h2>
              <p class="item-description">${description}</p>
            </div>
          </div>`;
      } else {
        contentHtml = `<a href="/uploads/exhibitions/${userUuid}/${exhibitionId}/${currentItem.filename}" class="download-link">Скачать файл (${currentItem.filename})</a>`;
      }

      container.innerHTML = `<div class="item-content">${contentHtml}</div>`;

      if (ext === 'md' || ext === 'html') {
        const url = `/uploads/exhibitions/${userUuid}/${exhibitionId}/${currentItem.filename}`;
        const key = currentItemIndex;
        if (slideCache[key]) {
          document.getElementById('layout-render').innerHTML = slideCache[key];
          document.getElementById('layout-render').querySelectorAll('.carousel').forEach(initCarousel);
        } else {
          fetch(url)
            .then(res => res.text())
            .then(text => {
              let rendered = ext === 'md' ? simpleMarkdown(text) : text;
              slideCache[key] = rendered;
              document.getElementById('layout-render').innerHTML = rendered;
              document.getElementById('layout-render').querySelectorAll('.carousel').forEach(initCarousel);
            });
        }
      }

      document.getElementById('page-indicator').textContent = `${currentItemIndex + 1}/${items.length}`;

      const block = container.querySelector('.layout-block');
      if (block) {
        block.classList.remove('fade-in', 'slide-in');
        block.classList.add('fade-in');
        block.style.setProperty('--anim-duration', '1s');
        block.style.animationTimingFunction = 'ease';
      }
    }

    function simpleMarkdown(md) {
      let html = md
        .replace(/^(#{1,6})\s*(.+)$/gm, (m, hashes, title) => `<h${hashes.length}>${title}</h${hashes.length}>`)
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*\*/g, '<em>$1</em>')
        .replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" style="max-width:100%;"/>')
        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
        .replace(/\n/g, '<br/>');
      html = html.replace(/\[carousel(?:\s+delay="([\d.]+)")?(?:\s+max_width="([^"]+)")?(?:\s+max_height="([^"]+)")?\]([\s\S]*?)\[\/carousel\]/g,
        (m, delay, maxW, maxH, inner) => {
          const interval = parseFloat(delay) || 3;
          const slides = inner.trim().split(/<br\/?\>/)
            .filter(s => s.trim())
            .map(item => {
              let style = '';
              if (maxW) style += `max-width:${maxW};`;
              if (maxH) style += `max-height:${maxH};`;
              return `<div class="slide" style="${style}">${item}</div>`;
            }).join('');
          return `<div class="carousel" data-delay="${interval}"><div class="slides">${slides}</div></div>`;
        });
      return html;
    }

    function initCarousel(carousel) {
      if (carousel._initialized) return;
      const slides = carousel.querySelector('.slides');
      const total = slides.children.length;
      let idx = 0;
      function show(i) { slides.style.transform = `translateX(-${i * 100}%)`; }
      show(idx);
      const delay = parseFloat(carousel.dataset.delay) || 3;
      setInterval(() => { idx = (idx + 1) % total; show(idx); }, delay * 1000);
      carousel._initialized = true;
    }

    function prevItem() {
      currentItemIndex = Math.max(0, currentItemIndex - 1);
      updateCurrentItem();
    }

    function nextItem() {
      currentItemIndex = Math.min(items.length - 1, currentItemIndex + 1);
      updateCurrentItem();
    }

    function isImage(filename) {
      if (!filename) return false;
      const ext = filename.split('.').pop().toLowerCase();
      return ['png', 'jpg', 'jpeg'].includes(ext);
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateCurrentItem();
    });

    document.addEventListener('keydown', e => {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.code === 'Space' || e.code === 'ArrowRight') {
        e.preventDefault(); nextItem();
      } else if (e.code === 'ArrowLeft') {
        e.preventDefault(); prevItem();
      }
    });
  </script>
{% endblock %}
